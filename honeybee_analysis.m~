%% This file performs a "dirty" analysis on preliminary data sent by Dr. Baird for honeybee approaches

%% Load data
clc; close all;
clear;

dataDir = '/home/reken001/Pulkit/honeybee';

dataFiles = dir(fullfile(dataDir,'*.mat'));

DirPlots = '/home/reken001/Pulkit/honeybee/rref_estimate';
delPreviousPlots = false; % BE CAREFUL - when set to true, all previously saved plots are deleted
savePlots = false;
savePDFs = false;



for ct=1:length(dataFiles)
    % loading track data
    dataFiles(ct).data = load(fullfile(dataFiles(ct).folder, dataFiles(ct).name));
    
    % creating landing track object
    landingTracks(ct) = BlindLandingtrack();
    N = length(dataFiles(ct).data.x);
    rawState = [ct*ones(N,1) [1:N]' [0:N-1]'/400 dataFiles(ct).data.x dataFiles(ct).data.y dataFiles(ct).data.z ...
        zeros(N, 12)];% 18 columns (obj_id	frame	timestamp	x	y	z	xvel	yvel	zvel P00	P01	P02	P11	P12	P22	P33	P44	P55)
    landingTracks(ct).rawTrack = rawState_BlindLandingtrack(rawState, 'Spiral');
    landingTracks(ct).dt = 1/400;
    landingTracks(ct).filterRawTracks(20);
    
    landingTracks(ct).raw_LDF = landingTracks(ct).rawTrack;
    landingTracks(ct).state_LDF = landingTracks(ct).state;
    
%     landingTracks(ct).plotDataLDF_Time_rawVSfiltered(1, []);
    landingTracks(ct).plotDataLDF_Distance(landingTracks(ct).state_LDF);
    
    landingTracks(ct).state_LDF.compute_rref(params, factors, time_window);
    
    if savePlots
        for ct_factor=1:length(factors)
            
            plotHandles = excerpt.plot_rrefs(factors(ct_factor));
            %                                       plotHandles = excerpt.plot_rrefs_with3dspeed(factors(ct_factor));
            
            if ~isempty(plotHandles)
                
                % Resizing the figures
                for i=1:length(plotHandles)
                    plotHandles(i).Position(3) = 680;
                    plotHandles(i).Position(4) = 545;
                    
                    if i==1
                        figureName = ['fac_' num2str(factors(ct_factor),'%0.2f') '_' ...
                            num2str(treatment.datenum) '_' ...
                            num2str(treatment.startTime) '_' num2str(treatment.endTime) ...
                            '_obj' num2str(track.obj_id) '_track' ...
                            num2str(ct_track) '_excerpt' num2str(ct_excerpt) ...
                            '.png'];
                    end
                    
                    saveas(plotHandles(i), fullfile(DirPlots_treatment, figureName) ,'png');
                    
                    if savePDFs
                        print(plotHandles(i), strrep(fullfile(DirPlots_treatment, figureName), ...
                            '.png','.pdf'), '-dpdf');
                    end
                end
                
                close(plotHandles);
                
            end
        end
    end
    
    keyboard
end


%% create 3d trajectory figure
trajFig = figure; hold on;
for ct=1:length(dataFiles)
    plot3(dataFiles(ct).data.x, dataFiles(ct).data.y, dataFiles(ct).data.z);
end
xlabel('x')
ylabel('y')
zlabel('z')
view([0 90]);
view([90 0]);